---
import { chapters, mockArticles } from '../lib/data';
import { fetchChapters, fetchArticles, sanityEnabled } from '../lib/sanity';
import type { Lang } from '../lib/data';

const { lang = 'en' } = Astro.props as { lang: Lang };

// Fetch real data if Sanity is enabled
const sanityChapters = sanityEnabled ? await fetchChapters() : null;
const sanityArticles = sanityEnabled ? await fetchArticles() : null;

const chaptersData = (sanityChapters || chapters).map((c) => ({
  number: c.number,
  slug: c.slug,
  title: c.title,
  description: c.description,
}));

const articlesData = (sanityArticles || mockArticles).map((a) => ({
  number: a.number,
  slug: a.slug,
  chapterSlug: a.chapterSlug,
  title: a.title,
  body: a.body,
}));

const t = {
  title: lang === 'en' ? 'Search' : 'Raadi',
  placeholder: lang === 'en' ? 'Search articles, chapters, keywords…' : 'Raadi qodobo, cutubyo, erayada…',
  hint: lang === 'en' ? 'Type to search. Enter to open.' : 'Qor si aad u raadiso. Enter si aad u furto.',
  chapters: lang === 'en' ? 'Chapters' : 'Cutubyo',
  articles: lang === 'en' ? 'Articles' : 'Qodobo',
};
---

<div id="searchModal" class="fixed inset-0 z-[60] hidden" data-lang={lang}>
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>

  <div class="relative mx-auto mt-20 w-full max-w-xl px-4">
    <div class="rounded-2xl border border-zinc-200 bg-white shadow-xl dark:border-zinc-800 dark:bg-zinc-950">
      <div class="flex items-center gap-3 border-b border-zinc-200 px-4 py-3 dark:border-zinc-800">
        <svg viewBox="0 0 24 24" class="h-5 w-5 text-zinc-500" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 21l-4.3-4.3"/>
          <circle cx="11" cy="11" r="7"></circle>
        </svg>
        <input
          id="searchInput"
          class="w-full bg-transparent text-sm outline-none placeholder:text-zinc-400"
          placeholder={t.placeholder}
          autocomplete="off"
        />
        <button id="searchClose" class="rounded-lg px-2 py-1 text-xs font-semibold text-zinc-500 hover:bg-zinc-100 dark:hover:bg-zinc-900">
          Esc
        </button>
      </div>

      <div class="px-4 py-3">
        <p class="text-xs text-zinc-500">{t.hint}</p>
        <ul id="searchResults" class="mt-3 grid gap-2 max-h-96 overflow-y-auto"></ul>
      </div>
    </div>
  </div>

  <script define:vars={{ chaptersData, articlesData, lang }}>
    (function () {
      const modal = document.getElementById('searchModal');
      const input = document.getElementById('searchInput');
      const closeBtn = document.getElementById('searchClose');
      const results = document.getElementById('searchResults');
      const openBtns = document.querySelectorAll('[data-open-search]');

      const chapters = chaptersData;
      const articles = articlesData;

      function pickText(obj, key) {
        const val = obj?.[key];
        return val?.[lang] ?? val?.en ?? val?.so ?? '';
      }

      function stripHtml(html) {
        const div = document.createElement('div');
        div.innerHTML = html || '';
        return div.textContent || '';
      }

      function open() {
        modal?.classList.remove('hidden');
        setTimeout(() => input?.focus(), 10);
        render('');
      }

      function close() {
        modal?.classList.add('hidden');
        if (input) input.value = '';
      }

      function render(q) {
        const query = (q || '').toLowerCase().trim();

        // Search chapters
        const chapterResults = chapters
          .filter((c) => {
            const title = pickText(c, 'title').toLowerCase();
            const desc = pickText(c, 'description').toLowerCase();
            return title.includes(query) || desc.includes(query);
          })
          .slice(0, 5)
          .map((c) => ({
            type: 'chapter',
            number: c.number,
            title: pickText(c, 'title'),
            href: `/${lang}/chapters/${c.slug}`,
          }));

        // Search articles - search in both English and Somali
        const articleResults = articles
          .filter((a) => {
            const titleEn = (a.title?.en || '').toLowerCase();
            const titleSo = (a.title?.so || '').toLowerCase();
            const bodyEn = stripHtml(a.body?.en || '').toLowerCase();
            const bodySo = stripHtml(a.body?.so || '').toLowerCase();

            return titleEn.includes(query) ||
                   titleSo.includes(query) ||
                   bodyEn.includes(query) ||
                   bodySo.includes(query);
          })
          .slice(0, 8)
          .map((a) => ({
            type: 'article',
            number: a.number,
            title: pickText(a, 'title'),
            href: `/${lang}/articles/${a.slug}`,
          }));

        const allResults = [...chapterResults, ...articleResults];

        if (!results) return;

        if (allResults.length === 0) {
          results.innerHTML = `<li class="py-4 text-center text-sm text-zinc-400">${lang === 'en' ? 'No results found' : 'Wax lama helin'}</li>`;
          return;
        }

        results.innerHTML = allResults
          .map((r) => {
            const label = r.type === 'chapter'
              ? `${lang === 'en' ? 'Chapter' : 'Cutub'} ${r.number}`
              : `${lang === 'en' ? 'Article' : 'Qodobka'} ${r.number}aad`;

            return `
              <li>
                <a href="${r.href}" class="flex items-center justify-between rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm hover:bg-zinc-50 dark:border-zinc-800 dark:bg-zinc-950 dark:hover:bg-zinc-900">
                  <div class="flex items-center gap-2">
                    <span class="rounded-md bg-zinc-100 px-2 py-0.5 text-xs font-semibold text-zinc-700 dark:bg-zinc-800 dark:text-zinc-300">${label}</span>
                    <span class="font-semibold text-zinc-800 dark:text-zinc-100">${r.title}</span>
                  </div>
                  <span class="text-zinc-400">↵</span>
                </a>
              </li>
            `;
          })
          .join('');
      }

      openBtns.forEach((b) => b.addEventListener('click', open));
      closeBtn?.addEventListener('click', close);

      modal?.addEventListener('click', (e) => {
        if (e.target === modal) close();
      });

      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal?.classList.contains('hidden')) close();
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          open();
        }
      });

      input?.addEventListener('input', (e) => render(e.target.value));
    })();
  </script>
</div>
