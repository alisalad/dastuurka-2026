---
import type { Lang } from '../lib/data';

const { lang = 'en', number, title, html, slug } = Astro.props as {
  lang: Lang;
  number: number;
  title: string;
  html: string;
  slug?: string;
};

const copyLabel = lang === 'en' ? 'Quick Copy' : 'Quick Copy';
const copiedLabel = lang === 'en' ? 'Copied!' : 'Copied!';
---

<article class="group rounded-lg border border-zinc-200/60 bg-white p-8 shadow-sm hover:shadow-md hover:border-zinc-300/80 hover:-translate-y-0.5 transition-all duration-200 dark:border-zinc-800/60 dark:bg-zinc-950 dark:hover:border-zinc-700/80 relative">
  <div>
    <p class="text-xs font-semibold uppercase tracking-wide text-zinc-400 dark:text-zinc-500">{lang === 'en' ? 'Article' : 'Qodobka'} {number}</p>
    <h3 class="mt-2 text-xl font-bold tracking-tight leading-snug">
      <a class="text-zinc-900 dark:text-zinc-100 hover:text-zinc-700 dark:hover:text-zinc-300 transition-colors" href={`/${lang}/articles/${slug ?? `article-${String(number).padStart(3,'0')}`}`}>{title}</a>
    </h3>
  </div>

  <div class="prose-const mt-5 text-zinc-600 dark:text-zinc-300 leading-relaxed" set:html={html} />

  <!-- Compact copy button at bottom-right -->
  <button
    class="absolute bottom-6 right-6 inline-flex items-center justify-center rounded-lg bg-zinc-50 p-2.5 text-zinc-600 hover:bg-zinc-100 hover:text-zinc-900 border border-zinc-200/60 dark:bg-zinc-900 dark:text-zinc-400 dark:hover:bg-zinc-800 dark:hover:text-zinc-200 dark:border-zinc-800/60 transition-all duration-150 opacity-0 group-hover:opacity-100"
    data-copy
    data-copied-label={copiedLabel}
    aria-label={copyLabel}
    title={copyLabel}
    type="button"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
    </svg>
  </button>

  <!-- Toast notification -->
  <div
    class="fixed bottom-4 left-1/2 -translate-x-1/2 rounded-lg bg-zinc-900 px-4 py-2 text-sm font-medium text-white shadow-lg dark:bg-zinc-100 dark:text-zinc-900 opacity-0 pointer-events-none transition-opacity duration-200"
    data-toast
  >
    {copiedLabel}
  </div>

  <script is:inline>
    (function () {
      const root = document.currentScript?.closest('article');
      if (!root) return;

      const btn = root.querySelector('[data-copy]');
      const content = root.querySelector('.prose-const');
      if (!btn || !content) return;

      // Split clauses in paragraphs
      const paragraphs = content.querySelectorAll('p');
      paragraphs.forEach(p => {
        const text = p.innerHTML;

        // First split by numbered clauses (1), (2), (3)
        if (/\(\d+\)/.test(text)) {
          const clauses = text.split(/(?=\(\d+\))/).filter(c => c.trim());
          if (clauses.length > 1) {
            const wrapper = document.createElement('div');
            clauses.forEach(clause => {
              // Check if this clause contains lettered sub-clauses
              if (/\([A-Za-z]\)/.test(clause)) {
                const subClauses = clause.split(/(?=\([A-Za-z]\))/).filter(sc => sc.trim());
                subClauses.forEach((subClause, idx) => {
                  const newP = document.createElement('p');
                  newP.innerHTML = subClause.trim();
                  // First part (numbered clause) - no indent
                  if (idx === 0) {
                    newP.className = 'mb-3 text-base leading-relaxed';
                  }
                  // Lettered sub-clauses - indent
                  else if (/^\([A-Za-z]\)/.test(subClause.trim())) {
                    newP.className = 'ml-8 mb-2 text-base leading-relaxed';
                  }
                  wrapper.appendChild(newP);
                });
              } else {
                const newP = document.createElement('p');
                newP.innerHTML = clause.trim();
                newP.className = 'mb-3 text-base leading-relaxed';
                wrapper.appendChild(newP);
              }
            });
            p.replaceWith(...wrapper.children);
          }
        }
        // Handle standalone lettered clauses (not part of numbered clauses)
        else if (/\([A-Za-z]\)/.test(text)) {
          const clauses = text.split(/(?=\([A-Za-z]\))/).filter(c => c.trim());
          if (clauses.length > 1) {
            const wrapper = document.createElement('div');
            clauses.forEach(clause => {
              const newP = document.createElement('p');
              newP.innerHTML = clause.trim();
              newP.className = 'ml-8 mb-2 text-base leading-relaxed';
              wrapper.appendChild(newP);
            });
            p.replaceWith(...wrapper.children);
          }
        }
      });

      const plain = (el) => (el.textContent || '').trim();

      btn.addEventListener('click', async () => {
        const titleEl = root.querySelector('h3');
        const text = [titleEl ? plain(titleEl) : '', plain(content)].filter(Boolean).join('\n\n');
        const toast = root.querySelector('[data-toast]');
        try {
          await navigator.clipboard.writeText(text);
          // Show toast notification
          if (toast) {
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');
            setTimeout(() => {
              toast.classList.remove('opacity-100');
              toast.classList.add('opacity-0');
            }, 1500);
          }
        } catch (e) {
          alert('Copy failed. Your browser may block clipboard access.');
        }
      });
    })();
  </script>
</article>
