\
---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import ArticleCard from '../../../../components/ArticleCard.astro';
import { chapters as mockChapters, mockArticles } from '../../../../lib/data';
import type { Chapter, Article } from '../../../../lib/data';
import { fetchChapterWithArticles, pickLang, fetchChapters } from '../../../../lib/sanity';
import { toHTML } from '@portabletext/to-html';

export const prerender = true;

export async function getStaticPaths() {
  const sanityChapters = await fetchChapters();
  const chapters = sanityChapters || mockChapters;
  return chapters.map((chapter: Chapter) => ({
    params: { chapterSlug: chapter.slug },
  }));
}

const lang = 'en';
const { chapterSlug } = Astro.params as { chapterSlug: string };

// Fetch from Sanity first
const sanityChapter = await fetchChapterWithArticles(chapterSlug);

let chapter: any;
let articles: any[] = [];

if (sanityChapter) {
  // Use Sanity data
  chapter = sanityChapter;
  articles = sanityChapter.articles || [];
} else {
  // Fallback to mock only if Sanity is unavailable
  chapter = mockChapters.find((c) => c.slug === chapterSlug);
  articles = mockArticles.filter((a) => a.chapterSlug === chapterSlug).sort((a, b) => a.number - b.number);
}

function safeTitle(obj: any) { return pickLang(obj, lang); }
function safeDesc(obj: any) { return pickLang(obj, lang); }
function bodyToHtml(bodyObj: any) {
  const blocks = bodyObj?.[lang] ?? bodyObj?.en ?? bodyObj?.so ?? [];
  try { return toHTML(blocks); } catch { return ''; }
}
---

<BaseLayout
  lang={lang}
  title={`${lang === 'en' ? 'Chapter' : 'Cutub'} ${chapter?.number ?? ''} — ${chapter ? safeTitle(chapter.title) : ''}`}
  description={chapter ? safeDesc(chapter.description) : ''}
>
  <section class="py-14">
    <div class="mx-auto max-w-6xl px-4">
      <a href={`/${lang}`} class="text-sm font-semibold text-sky-700 hover:text-sky-800 dark:text-sky-300 dark:hover:text-sky-200">
        ← {lang === 'en' ? 'Back to chapters' : 'Ku noqo cutubyada'}
      </a>

      <div class="mt-6 flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <p class="text-xs font-semibold text-zinc-500 dark:text-zinc-400">{lang === 'en' ? 'Chapter' : 'Cutub'} {chapter?.number}</p>
          <h1 class="mt-2 text-3xl font-extrabold tracking-tight sm:text-4xl">
            <span class="bg-gradient-to-r from-sky-500 to-sky-700 bg-clip-text text-transparent dark:from-sky-300 dark:to-sky-400">
              {chapter ? safeTitle(chapter.title) : (lang === 'en' ? 'Chapter not found' : 'Cutub lama helin')}
            </span>
          </h1>
          <p class="mt-3 max-w-prose text-zinc-600 dark:text-zinc-300">{chapter ? safeDesc(chapter.description) : ''}</p>
        </div>

        <div class="rounded-2xl border border-zinc-200 bg-white px-4 py-3 text-sm text-zinc-700 shadow-sm dark:border-zinc-800 dark:bg-zinc-950 dark:text-zinc-200">
          <span class="font-semibold">{articles?.length ?? 0}</span> {lang === 'en' ? 'articles' : 'qodob'}
        </div>
      </div>

      <div class="mt-8 grid gap-4">
        {articles.map((a) => (
          <ArticleCard
            lang={lang}
            number={a.number}
            slug={a.slug ?? `article-${String(a.number).padStart(3, '0')}`}
            title={safeTitle(a.title) || (lang === 'en' ? `Article ${a.number}` : `Qodobka ${a.number}`)}
            html={a.body ? bodyToHtml(a.body) : `<p>${(a.body as any)?.[lang] ?? (a.body as any)?.en ?? (a.body as any)?.so ?? ''}</p>`}
          />
        ))}
      </div>
    </div>
  </section>
</BaseLayout>
