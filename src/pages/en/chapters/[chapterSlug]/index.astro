\
---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import ArticleCard from '../../../../components/ArticleCard.astro';
import { chapters as mockChapters, mockArticles } from '../../../../lib/data';
import type { Chapter, Article } from '../../../../lib/data';
import { fetchChapterWithArticles, pickLang, fetchChapters } from '../../../../lib/sanity';
import { toHTML } from '@portabletext/to-html';

export const prerender = true;

export async function getStaticPaths() {
  const sanityChapters = await fetchChapters();
  const chapters = sanityChapters || mockChapters;
  return chapters.map((chapter: Chapter) => ({
    params: { chapterSlug: chapter.slug },
  }));
}

const lang = 'en';
const { chapterSlug } = Astro.params as { chapterSlug: string };

// Fetch from Sanity first
const sanityChapter = await fetchChapterWithArticles(chapterSlug);

let chapter: any;
let articles: any[] = [];

if (sanityChapter) {
  // Use Sanity data
  chapter = sanityChapter;
  articles = sanityChapter.articles || [];
} else {
  // Fallback to mock only if Sanity is unavailable
  chapter = mockChapters.find((c) => c.slug === chapterSlug);
  articles = mockArticles.filter((a) => a.chapterSlug === chapterSlug).sort((a, b) => a.number - b.number);
}

function safeTitle(obj: any) { return pickLang(obj, lang); }
function safeDesc(obj: any) { return pickLang(obj, lang); }
function bodyToHtml(bodyObj: any) {
  const blocks = bodyObj?.[lang] ?? bodyObj?.en ?? bodyObj?.so ?? [];
  try { return toHTML(blocks); } catch { return ''; }
}

// Calculate article range for this chapter
const allChapters = await fetchChapters() || mockChapters;
const chapterIndex = allChapters.findIndex((c: Chapter) => c.slug === chapterSlug);
let startArticle = 1;
for (let i = 0; i < chapterIndex; i++) {
  startArticle += allChapters[i].articleCount;
}
const endArticle = startArticle + (articles?.length ?? 0) - 1;
const articleRangeLabel = lang === 'en' 
  ? `Articles ${startArticle} - ${endArticle}`
  : `Qodobka ${startArticle}aad - ${endArticle}aad`;
---

<BaseLayout
  lang={lang}
  title={`${lang === 'en' ? 'Chapter' : 'Cutub'} ${chapter?.number ?? ''} — ${chapter ? safeTitle(chapter.title) : ''}`}
  description={chapter ? safeDesc(chapter.description) : ''}
>
  <section class="py-14">
    <div class="mx-auto max-w-6xl px-4">
      <a href={`/${lang}`} class="text-sm font-semibold text-sky-700 hover:text-sky-800 dark:text-sky-300 dark:hover:text-sky-200">
        ← {lang === 'en' ? 'Back to chapters' : 'Ku noqo cutubyada'}
      </a>

      <div class="mt-6">
        <p class="text-sm font-medium text-zinc-500 dark:text-zinc-400">{lang === 'en' ? 'Chapter' : 'Cutub'} {chapter?.number}</p>
        <h1 class="mt-2 text-xl font-semibold tracking-tight sm:text-2xl lg:text-3xl">
          <span class="bg-gradient-to-r from-sky-600 to-sky-800 bg-clip-text text-transparent dark:from-sky-300 dark:to-sky-400">
            {chapter ? safeTitle(chapter.title) : (lang === 'en' ? 'Chapter not found' : 'Cutub lama helin')}
          </span>
        </h1>
        <div class="mt-3 flex items-center gap-3">
          <p class="max-w-prose text-zinc-600 dark:text-zinc-300">{chapter ? safeDesc(chapter.description) : ''}</p>
          <span class="inline-flex shrink-0 items-center gap-1.5 rounded-full bg-sky-50 px-3 py-1 text-xs font-medium text-sky-700 ring-1 ring-sky-200/70 dark:bg-sky-500/10 dark:text-sky-300 dark:ring-sky-400/25">
            {articleRangeLabel}
          </span>
        </div>
      </div>

      <div class="mt-8 grid gap-4">
        {articles.map((a) => (
          <ArticleCard
            lang={lang}
            number={a.number}
            slug={a.slug ?? `article-${String(a.number).padStart(3, '0')}`}
            title={safeTitle(a.title) || (lang === 'en' ? `Article ${a.number}` : `Qodobka ${a.number}`)}
            html={a.body ? bodyToHtml(a.body) : `<p>${(a.body as any)?.[lang] ?? (a.body as any)?.en ?? (a.body as any)?.so ?? ''}</p>`}
          />
        ))}
      </div>
    </div>
  </section>
</BaseLayout>
